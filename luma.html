<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Luma - Learn Better | KnowEasy</title>
    <meta name="description" content="AI-powered adaptive learning system">
    <link href="favicon.ico" rel="icon">
    <link href="styles.css" rel="stylesheet">
    <link href="luma-ultimate.css" rel="stylesheet">
    <meta content="#6B7FFF" name="theme-color">
    
    <!-- PWA -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192x192.png">
    <link rel="manifest" href="manifest.json">
    
    <!-- Libraries for Math & Diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">

<style>
.luma-mermaid { margin-top: 12px; }
.luma-mermaid .mermaid { overflow-x: auto; }
.luma-caption { margin-top: 8px; font-size: 14px; opacity: .75; }
</style>
</head>
<body class="has-app">
<div class="app">
    <!-- Toast Notification -->
    <div class="luma-toast" id="lumaToast" role="alert" aria-live="polite">
        <div class="luma-toast-icon">üéâ</div>
        <div class="luma-toast-text">Notification</div>
    </div>

    <header class="app-header">
        <div style="display:flex; align-items:center; gap:12px;">
            <div class="app-header__brand">
                <div class="brand-logo">KE</div>
                <div class="brand-text">
                    <div class="brand-title">KnowEasy</div>
                    <div class="brand-subtitle">Luma Learning</div>
                </div>
            </div>
        </div>
        <button class="app-header__profile-btn" onclick="window.location.href='library.html'" type="button" style="margin-right:10px; width:auto; padding:10px 14px;">Library</button>
        <button class="app-header__profile-btn" onclick="window.location.href='me.html'" type="button">
            <span class="profile-avatar">A</span>
        </button>
    </header>

    <main class="app-main">
        <div class="luma-app" id="lumaApp">
            <div class="luma-container">
                
                <!-- Loading/Upload Screen -->
                <div class="luma-loading" id="uploadScreen">
                    <div class="luma-spinner"></div>
                    <h2 class="luma-loading-text">Loading your lesson...</h2>
                    <p style="margin: 20px 0; color: var(--text-tertiary);">
                        Preparing content from backend
                    </p>
                </div>

                <!-- Header Content (populated by Luma.js) -->
                <div class="hidden" id="headerContent"></div>

                <!-- Main Layout -->
                <div class="hidden luma-main" id="lumaMain">
                    <!-- Timeline Sidebar -->
                    <aside class="luma-sidebar" id="lumaSidebar"></aside>

                    <!-- Main Content -->
                    <main class="luma-content" id="lumaContent"></main>

                    <!-- AI Sidebar (Desktop) -->
                    <aside class="luma-ai-sidebar" id="lumaAiSidebar">
                        <div class="luma-ai-header">
                            <div class="luma-ai-icon">ü§ñ</div>
                            <div>
                                <div class="luma-ai-title">Lumi AI</div>
                                <div style="font-size: 11px; opacity: 0.8;">Ask me anything!</div>
                            </div>
                        </div>
                        <div class="luma-ai-messages" id="aiMessages">
                            <div class="luma-ai-message assistant">
                                üëã Hi! I'm Lumi. Ask me doubts or request explanations!
                            </div>
                        </div>
                        <div class="luma-ai-input-container">
                            <textarea class="luma-ai-input" id="aiInput" placeholder="Ask..." rows="2"></textarea>
                            <button class="luma-ai-send" id="aiSendButton">üì§</button>
                        </div>
                        <div style="margin-top: 12px; padding: 8px; background: rgba(107,127,255,0.1); border-radius: 12px; font-size: 11px; text-align: center;">
                            <span id="aiRateLimit">Free: 3 questions/day</span>
                            <button class="luma-btn-premium-mini" onclick="window.location.href='me.html?tab=premium'" style="margin-top: 6px;">
                                ‚≠ê Go Premium
                            </button>
                        </div>
                    </aside>
                </div>

            </div>
        </div>
    </main>

    <!-- AI FAB (Mobile) -->
    <button class="luma-ai-fab" id="lumaAiFab">ü§ñ</button>

    <nav class="bottom-nav">
        <button class="bottom-nav__item" onclick="window.location.href='index.html'" type="button">
            <img alt="Home" class="nav-icon" src="assets/nav-home.svg">
            <span class="bottom-nav__label">Home</span>
        </button>
        <button class="bottom-nav__item" onclick="window.location.href='study.html'" type="button">
            <img alt="Study" class="nav-icon" src="assets/nav-study.svg">
            <span class="bottom-nav__label">Study</span>
        </button>
        <button class="bottom-nav__item bottom-nav__item--active" type="button">
            <img alt="Luma" class="nav-icon" src="assets/nav-chat.svg">
            <span class="bottom-nav__label">Luma</span>
        </button>
        <button class="bottom-nav__item" onclick="window.location.href='test.html'" type="button">
            <img alt="Test" class="nav-icon" src="assets/nav-test.svg">
            <span class="bottom-nav__label">Test</span>
        </button>
        <button class="bottom-nav__item" onclick="window.location.href='me.html'" type="button">
            <img alt="Me" class="nav-icon" src="assets/nav-me.svg">
            <span class="bottom-nav__label">Me</span>
        </button>
    </nav>
</div>

<script src="core.js?v=20260204"></script>
<script src="auth.js"></script>
<script src="app.js"></script>
<script src="luma.js"></script>
<script src="luma-ai.js"></script>
<script src="luma-premium.js"></script>
<script>
// Initialize Mermaid for diagrams
mermaid.initialize({ 
    startOnLoad: false,
    theme: 'default',
    themeVariables: {
        primaryColor: '#E0E7FF',
        primaryTextColor: '#1E293B',
        primaryBorderColor: '#6B7FFF',
        lineColor: '#64748B'
    }
});

const API_BASE = window.API_BASE || 'https://knoweasy-engine-api.onrender.com';

// Main initialization
document.addEventListener('DOMContentLoaded', async () => {
    console.log('üéì Luma Universal System initializing...');
    
    // Initialize Luma engine
    window.luma = new Luma();
    window.lumaAI = new LumaAI(window.luma);
    
    // Start content loading from backend
    await loadContentFromBackend();
    
    console.log('‚úÖ Luma ready!');
});

async function loadContentFromBackend() {
    const uploadScreen = document.getElementById('uploadScreen');
    
    try {
        const params = new URLSearchParams(window.location.search);
        const contentId = params.get('content_id');
        const title = params.get('title') || params.get('chapter_title');
        
        // Handle coming-soon with resolution
        if (!contentId || contentId === 'coming-soon') {
            console.log('[Luma] üîç Detected coming-soon. Attempting resolution...');
            
            const ctx = {
                track: params.get("track"),
                program: params.get("program"),
                class_num: params.get("class_num"),
                subject_slug: params.get("subject_slug"),
                chapter_id: params.get("chapter_id"),
                chapter_title: params.get("chapter_title") || title
            };
            
            // Try localStorage fallback
            if (!(ctx.track && ctx.program && ctx.class_num && ctx.subject_slug)) {
                try {
                    const saved = localStorage.getItem("ke_last_chapter_context");
                    if (saved) Object.assign(ctx, JSON.parse(saved));
                } catch (e) {}
            }
            
            const titleFallback = ctx.chapter_title || "Coming Soon";
            
            // Attempt resolution
            if (ctx.track && ctx.program && ctx.class_num && ctx.subject_slug && (ctx.chapter_id || ctx.chapter_title)) {
                console.log('[Luma] Attempting resolution with context:', ctx);
                
                const qs = new URLSearchParams();
                qs.set("track", ctx.track);
                qs.set("program", ctx.program);
                qs.set("class_num", String(ctx.class_num));
                qs.set("subject_slug", ctx.subject_slug);
                if (ctx.chapter_id) qs.set("chapter_id", ctx.chapter_id);
                if (ctx.chapter_title) qs.set("chapter_title", ctx.chapter_title);
                
                const res = await fetch(`${API_BASE}/api/study/resolve?${qs.toString()}`);
                console.log('[Luma] Resolve API called:', `${API_BASE}/api/study/resolve?${qs.toString()}`);
                
                if (res.ok) {
                    const data = await res.json();
                    console.log('[Luma] Resolve response:', data);
                    
                    const resolvedId = data && (data.content_id || (data.asset && data.asset.content_id));
                    if (resolvedId) {
                        console.log('[Luma] ‚úÖ Resolution successful! content_id:', resolvedId);
                        
                        // Update URL and reload
                        const newQS = new URLSearchParams(window.location.search);
                        newQS.set("content_id", resolvedId);
                        history.replaceState(null, "", `${window.location.pathname}?${newQS.toString()}`);
                        
                        // Continue loading with resolved ID
                        return await loadContentFromBackend();
                    }
                }
            }
            
            console.log('[Luma] ‚ùå Resolution not possible. Showing Coming Soon for:', titleFallback);
            showComingSoon(titleFallback);
            return;
        }
        
        // Fetch content from backend
        console.log('[Luma] Loading content:', contentId);
        const response = await fetch(`${API_BASE}/api/luma/content/${encodeURIComponent(contentId)}`);
        
        if (!response.ok) {
            if (title) {
                showComingSoon(title);
                return;
            }
            throw new Error(`Content not found (ID: ${contentId})`);
        }
        
        const result = await response.json();
        
        if (!result.ok || !result.content) {
            if (title) {
                showComingSoon(title);
                return;
            }
            throw new Error('Content not found');
        }
        
        const content = result.content;
        console.log('[Luma] ‚úÖ Content loaded successfully');
        
        // Convert backend format to universal Luma format
        const lumaContent = convertToLumaFormat(content);
        
        // FIXED: Use loadData() not loadContent()
        window.luma.loadData(lumaContent);
        
    } catch (error) {
        console.error('[Luma] Load error:', error);
        showError(error.message);
    }
}

function convertToLumaFormat(backendContent) {
    // Convert old blueprint format to new universal format
    const { metadata, blueprint } = backendContent;
    
    const sections = [];
    const cards = [];
    
    // Add Why It Matters
    if (blueprint.why_it_matters) {
        cards.push({
            id: 'card-why',
            type: 'explain',
            title: 'üí° Why This Matters',
            content: [blueprint.why_it_matters]
        });
    }
    
    // Add Conceptual Foundation
    if (blueprint.conceptual_foundation) {
        cards.push({
            id: 'card-concept',
            type: 'explain',
            title: 'üìö Conceptual Foundation',
            content: [blueprint.conceptual_foundation]
        });
    }
    
    // Add Visual if present
    if (blueprint.visual) {
        cards.push({
            id: 'card-visual',
            type: 'visual',
            title: 'üé® Visual Mental Model',
            content: blueprint.visual.caption || '',
            diagram: {
                type: blueprint.visual.type || 'mermaid',
                code: blueprint.visual.code
            }
        });
    }
    
    // Add Steps
    if (blueprint.steps && blueprint.steps.length > 0) {
        const stepCards = blueprint.steps.map((step, idx) => ({
            id: `card-step-${idx + 1}`,
            type: 'explain',
            title: `üìù Step ${step.number}: ${step.title || ''}`,
            content: [step.content]
        }));
        cards.push(...stepCards);
    }
    
    // Add Alternative Method
    if (blueprint.alternative_method) {
        cards.push({
            id: 'card-alt',
            type: 'explain',
            title: 'üîÑ Alternative Approach',
            content: [blueprint.alternative_method]
        });
    }
    
    // Add Common Mistakes
    if (blueprint.common_mistakes && blueprint.common_mistakes.length > 0) {
        cards.push({
            id: 'card-mistakes',
            type: 'activity',
            title: '‚ö†Ô∏è Common Exam Traps',
            content: blueprint.common_mistakes.map((m, i) => `**${i + 1}.** ${m}`).join('\n\n')
        });
    }
    
    // Add Practice Questions
    if (blueprint.practice && blueprint.practice.length > 0) {
        const practiceCards = blueprint.practice.map((q, idx) => ({
            id: `card-practice-${idx + 1}`,
            type: 'practice',
            title: `‚úèÔ∏è Practice ${idx + 1}`,
            content: q.text,
            commonDoubts: q.hint ? [{
                question: 'Hint',
                answer: q.hint,
                difficulty: 'Medium'
            }] : []
        }));
        cards.push(...practiceCards);
    }
    
    // Add Exam Relevance
    if (blueprint.exam_relevance) {
        cards.push({
            id: 'card-exam',
            type: 'activity',
            title: 'üéØ Exam Strategy',
            content: blueprint.exam_relevance
        });
    }
    
    sections.push({
        id: 'section-1',
        title: 'Main Content',
        description: metadata.chapter || metadata.topic || blueprint.title,
        cards
    });
    
    return {
        metadata: {
            title: blueprint.title || metadata.chapter || metadata.topic || 'Lesson',
            subject: metadata.subject || 'Subject',
            class: String(metadata.class_level || metadata.class || ''),
            board: metadata.board || 'Board',
            examType: metadata.track === 'entrance' ? metadata.program.toUpperCase() : 'Board Exam',
            difficulty: metadata.difficulty || 'Medium',
            language: 'en',
            totalCards: cards.length,
            estimatedTime: `${Math.ceil(cards.length * 3)} minutes`,
            tags: metadata.tags || []
        },
        sections
    };
}

function showComingSoon(title) {
    const uploadScreen = document.getElementById('uploadScreen');
    uploadScreen.innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 64px; margin-bottom: 20px;">üìö</div>
            <h2 style="font-size: 24px; margin-bottom: 12px; color: var(--text-primary);">${escapeHtml(title)}</h2>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">
                This chapter is not available yet. Only published content appears here.
            </p>
            <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                <button onclick="window.history.back()" class="luma-btn luma-btn-secondary">
                    ‚Üê Go Back
                </button>
                <button onclick="window.location.href='study.html'" class="luma-btn luma-btn-next">
                    Browse Chapters
                </button>
            </div>
        </div>
    `;
}

function showError(message) {
    const uploadScreen = document.getElementById('uploadScreen');
    uploadScreen.innerHTML = `
        <div style="text-align: center; padding: 40px 20px;">
            <div style="font-size: 64px; margin-bottom: 20px;">‚ö†Ô∏è</div>
            <h2 style="font-size: 24px; margin-bottom: 12px; color: var(--text-primary);">Unable to Load</h2>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">
                ${escapeHtml(message)}
            </p>
            <button onclick="window.location.reload()" class="luma-btn luma-btn-next">
                üîÑ Retry
            </button>
        </div>
    `;
}

function escapeHtml(str) {
    return String(str || '').replace(/[&<>"']/g, c => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[c]));
}
</script>
<script src="sw-disable.js"></script>
</body>
</html>
